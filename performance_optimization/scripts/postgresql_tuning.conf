# PostgreSQL Performance Tuning for Odoo 15 with Large Product Catalogs
# 
# This file contains recommended PostgreSQL settings for optimal performance
# with 28,000+ product variants
#
# Installation Instructions:
# 1. Backup your current postgresql.conf:
#    sudo cp /etc/postgresql/*/main/postgresql.conf /etc/postgresql/*/main/postgresql.conf.backup
#
# 2. Append these settings to /etc/postgresql/*/main/postgresql.conf
#    OR create a new file in /etc/postgresql/*/main/conf.d/odoo_performance.conf
#
# 3. Restart PostgreSQL:
#    sudo systemctl restart postgresql
#
# Note: Adjust values based on your server's RAM and CPU cores

# ============================================================================
# MEMORY SETTINGS
# ============================================================================

# shared_buffers: 25% of system RAM (for 8GB RAM = 2GB)
shared_buffers = 2GB

# effective_cache_size: 50-75% of system RAM (for 8GB RAM = 6GB)
# This tells PostgreSQL how much memory is available for disk caching
effective_cache_size = 6GB

# work_mem: Memory for sorting and hash operations
# Formula: (Total RAM * 0.25) / max_connections / 2
# For 8GB RAM with 100 connections = 10MB
work_mem = 10MB

# maintenance_work_mem: Memory for VACUUM, CREATE INDEX, etc.
# Recommended: 5-10% of system RAM
maintenance_work_mem = 512MB

# ============================================================================
# CHECKPOINT SETTINGS
# ============================================================================

# wal_buffers: 3% of shared_buffers, max 16MB
wal_buffers = 16MB

# checkpoint_completion_target: Spread checkpoint I/O over more time
checkpoint_completion_target = 0.9

# min_wal_size: Minimum size of WAL files
min_wal_size = 1GB

# max_wal_size: Maximum size of WAL files
max_wal_size = 4GB

# ============================================================================
# QUERY PLANNER SETTINGS
# ============================================================================

# default_statistics_target: More statistics for better query plans
# Default is 100, increase for complex queries
default_statistics_target = 100

# random_page_cost: Cost of random disk page fetch
# For SSD: 1.1, for HDD: 4.0
random_page_cost = 1.1

# effective_io_concurrency: Number of concurrent I/O operations
# For SSD: 200, for HDD: 2
effective_io_concurrency = 200

# ============================================================================
# LOGGING (for performance monitoring)
# ============================================================================

# Log slow queries for optimization
log_min_duration_statement = 1000  # Log queries taking more than 1 second

# Log checkpoints for monitoring
log_checkpoints = on

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================

# max_connections: Should match Odoo's db_maxconn + some buffer
max_connections = 150

# ============================================================================
# AUTOVACUUM SETTINGS (important for Odoo!)
# ============================================================================

# Enable autovacuum (should always be on)
autovacuum = on

# autovacuum_max_workers: Increase for better maintenance
autovacuum_max_workers = 4

# autovacuum_naptime: How often to run autovacuum (in seconds)
autovacuum_naptime = 30s

# More aggressive autovacuum for high-write tables
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# ============================================================================
# ADDITIONAL PERFORMANCE SETTINGS
# ============================================================================

# Parallel query execution (PostgreSQL 9.6+)
max_parallel_workers_per_gather = 2
max_parallel_workers = 4

# Enable JIT compilation (PostgreSQL 11+)
jit = on

